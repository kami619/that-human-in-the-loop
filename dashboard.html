<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Heuristics | In the Loop</title>
    <style>
        :root {
            --bg: #0a0a0a;
            --card-bg: #111;
            --accent: #00ff88;
            --text: #ffffff;
            --text-dim: #888;
            --border: #333;
            --card-radius: 12px;
        }

        body,
        html {
            margin: 0;
            padding: 0;
            background: var(--bg);
            color: var(--text);
            font-family: 'Courier New', Courier, monospace;
            min-height: 100vh;
        }

        /* Scanline Effect */
        body::after {
            content: " ";
            position: fixed;
            top: 0;
            left: 0;
            bottom: 0;
            right: 0;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%),
                linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06));
            background-size: 100% 2px, 3px 100%;
            pointer-events: none;
            z-index: 9999;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 0 40px;
            border-bottom: 1px solid var(--border);
            margin-bottom: 20px;
        }

        h1 {
            font-size: 1.5rem;
            letter-spacing: 2px;
            text-transform: uppercase;
            margin: 0;
        }

        h1 span {
            color: var(--accent);
        }

        .back-link {
            text-decoration: none;
            color: var(--text-dim);
            font-size: 0.9rem;
            transition: color 0.3s;
        }

        .back-link:hover {
            color: var(--accent);
        }

        /* Grid Layout */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            grid-auto-rows: minmax(300px, auto);
        }

        /* Responsive adjustments */
        @media (max-width: 1024px) {
            .dashboard-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 768px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Card Styles */
        .card {
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: var(--card-radius);
            padding: 20px;
            display: flex;
            flex-direction: column;
            position: relative;
            overflow: hidden;
            transition: transform 0.3s, border-color 0.3s;
        }

        .card:hover {
            border-color: var(--accent);
            transform: translateY(-2px);
        }

        .card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .card-title {
            font-size: 1rem;
            font-weight: bold;
            color: var(--accent);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .card-content {
            flex-grow: 1;
            overflow: auto;
        }

        /* Specific Spans */
        .col-span-2 {
            grid-column: span 2;
        }

        .row-span-2 {
            grid-row: span 2;
        }

        @media (max-width: 1024px) {
            .col-span-2 {
                grid-column: span 1;
            }
        }
    </style>
</head>

<body>

    <div class="container">
        <header>
            <h1>Heuristics <span>Dashboard</span></h1>
            <a href="index.html" class="back-link">&larr; Back to The Loop</a>
        </header>

        <div class="dashboard-grid">
            <!-- 1. Weather Widget -->
            <div class="card" id="widget-weather">
                <div class="card-header">
                    <span class="card-title">Local Atmosphere</span>
                    <span id="weather-location" style="font-size: 0.8rem; color: #666;">Locating...</span>
                </div>
                <div class="card-content"
                    style="display: flex; flex-direction: column; justify-content: space-between;">
                    <div style="display: flex; align-items: center; gap: 15px;">
                        <div id="weather-temp" style="font-size: 2.5rem; font-weight: bold; color: var(--text);">--°C
                        </div>
                        <div id="weather-condition" style="color: var(--accent); text-transform: uppercase;">Scanning...
                        </div>
                    </div>
                    <div class="recommendation"
                        style="margin-top: 15px; padding: 10px; background: rgba(255,255,255,0.05); border-radius: 8px; font-size: 0.9rem;">
                        <span style="color: #888;">ADVISORY:</span> <span id="weather-advice">Awaiting data...</span>
                    </div>
                </div>
            </div>

            <!-- 2. Clocks Widget -->
            <div class="card" id="widget-clocks">
                <div class="card-header">
                    <span class="card-title">Chronometers</span>
                </div>
                <div class="card-content" style="display: flex; flex-direction: column; gap: 10px;">
                    <!-- Clock 1 -->
                    <div class="clock-row"
                        style="display: flex; justify-content: space-between; align-items: center; padding-bottom: 8px; border-bottom: 1px solid #222;">
                        <select class="timezone-select" id="tz1" onchange="updateClocks()">
                            <option value="America/New_York">New York</option>
                            <option value="Europe/London">London</option>
                            <option value="Asia/Tokyo">Tokyo</option>
                            <option value="UTC">UTC</option>
                        </select>
                        <div class="time-display" id="time1"
                            style="font-family: monospace; font-size: 1.1rem; color: var(--accent);">--:--:--</div>
                    </div>
                    <!-- Clock 2 -->
                    <div class="clock-row"
                        style="display: flex; justify-content: space-between; align-items: center; padding-bottom: 8px; border-bottom: 1px solid #222;">
                        <select class="timezone-select" id="tz2" onchange="updateClocks()">
                            <option value="Europe/London">London</option>
                            <option value="America/New_York">New York</option>
                            <option value="Asia/Tokyo">Tokyo</option>
                            <option value="UTC">UTC</option>
                        </select>
                        <div class="time-display" id="time2"
                            style="font-family: monospace; font-size: 1.1rem; color: var(--accent);">--:--:--</div>
                    </div>
                    <!-- Clock 3 -->
                    <div class="clock-row" style="display: flex; justify-content: space-between; align-items: center;">
                        <select class="timezone-select" id="tz3" onchange="updateClocks()">
                            <option value="Asia/Tokyo">Tokyo</option>
                            <option value="America/New_York">New York</option>
                            <option value="Europe/London">London</option>
                            <option value="UTC">UTC</option>
                        </select>
                        <div class="time-display" id="time3"
                            style="font-family: monospace; font-size: 1.1rem; color: var(--accent);">--:--:--</div>
                    </div>
                </div>
                <style>
                    .timezone-select {
                        background: transparent;
                        color: #888;
                        border: none;
                        outline: none;
                        font-family: inherit;
                        font-size: 0.8rem;
                        cursor: pointer;
                    }

                    .timezone-select:hover {
                        color: #fff;
                    }
                </style>
            </div>

            <!-- 3. LLM Arena Widget -->
            <div class="card row-span-2" id="widget-arena">
                <div class="card-header">
                    <span class="card-title">Intelligence Arena</span>
                    <span style="font-size: 0.7rem; color: #666;">LIVE RANKING</span>
                </div>
                <div class="card-content">
                    <table style="width: 100%; border-collapse: collapse; font-size: 0.8rem;">
                        <thead>
                            <tr style="border-bottom: 1px solid #333; text-align: left;">
                                <th style="padding: 8px 4px; color: #888;">#</th>
                                <th style="padding: 8px 4px; color: #888;">MODEL</th>
                                <th style="padding: 8px 4px; text-align: right; color: #888;">ELO</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr style="border-bottom: 1px solid #222;">
                                <td style="padding: 10px 4px; color: var(--accent);">1</td>
                                <td style="padding: 10px 4px;">SearchGPT / GPT-4o</td>
                                <td style="padding: 10px 4px; text-align: right;">1320</td>
                            </tr>
                            <tr style="border-bottom: 1px solid #222;">
                                <td style="padding: 10px 4px; color: var(--accent);">2</td>
                                <td style="padding: 10px 4px;">Gemini 1.5 Pro</td>
                                <td style="padding: 10px 4px; text-align: right;">1301</td>
                            </tr>
                            <tr style="border-bottom: 1px solid #222;">
                                <td style="padding: 10px 4px; color: var(--accent);">3</td>
                                <td style="padding: 10px 4px;">Claude 3.5 Sonnet</td>
                                <td style="padding: 10px 4px; text-align: right;">1288</td>
                            </tr>
                            <tr style="border-bottom: 1px solid #222;">
                                <td style="padding: 10px 4px;">4</td>
                                <td style="padding: 10px 4px;">Llama 3.1 405B</td>
                                <td style="padding: 10px 4px; text-align: right;">1265</td>
                            </tr>
                            <tr style="border-bottom: 1px solid #222;">
                                <td style="padding: 10px 4px;">5</td>
                                <td style="padding: 10px 4px;">GPT-4 Turbo</td>
                                <td style="padding: 10px 4px; text-align: right;">1255</td>
                            </tr>
                        </tbody>
                    </table>
                    <div style="margin-top: 15px; font-size: 0.7rem; color: #555; text-align: center;">
                        *Updated daily via scale/elo
                    </div>
                </div>
            </div>

            <!-- 4. Major Indices Widget (Wide) -->
            <div class="card col-span-2" id="widget-indices">
                <div class="card-header">
                    <span class="card-title">Global Markets</span>
                </div>
                <div class="card-content" style="padding:0; overflow:hidden; position:relative;">
                    <!-- TradingView Widget BEGIN -->
                    <div class="tradingview-widget-container" style="height:100%; width:100%">
                        <div class="tradingview-widget-container__widget" style="height:calc(100% - 32px); width:100%">
                        </div>
                        <script type="text/javascript"
                            src="https://s3.tradingview.com/external-embedding/embed-widget-market-overview.js" async>
                                {
                                    "colorTheme": "dark",
                                        "dateRange": "12M",
                                            "showChart": true,
                                                "locale": "en",
                                                    "largeChartUrl": "",
                                                        "isTransparent": true,
                                                            "showSymbolLogo": true,
                                                                "showFloatingTooltip": false,
                                                                    "width": "100%",
                                                                        "height": "100%",
                                                                            "plotLineColorGrowing": "rgba(0, 255, 136, 1)",
                                                                                "plotLineColorFalling": "rgba(255, 0, 0, 1)",
                                                                                    "gridLineColor": "rgba(240, 243, 250, 0)",
                                                                                        "scaleFontColor": "rgba(106, 109, 120, 1)",
                                                                                            "belowLineFillColorGrowing": "rgba(0, 255, 136, 0.12)",
                                                                                                "belowLineFillColorFalling": "rgba(255, 0, 0, 0.12)",
                                                                                                    "belowLineFillColorGrowingBottom": "rgba(0, 255, 136, 0)",
                                                                                                        "belowLineFillColorFallingBottom": "rgba(255, 0, 0, 0)",
                                                                                                            "symbolActiveColor": "rgba(0, 255, 136, 0.12)",
                                                                                                                "tabs": [
                                                                                                                    {
                                                                                                                        "title": "Indices",
                                                                                                                        "symbols": [
                                                                                                                            {
                                                                                                                                "s": "FOREXCOM:SPXUSD",
                                                                                                                                "d": "S&P 500"
                                                                                                                            },
                                                                                                                            {
                                                                                                                                "s": "FOREXCOM:NSXUSD",
                                                                                                                                "d": "Nasdaq 100"
                                                                                                                            },
                                                                                                                            {
                                                                                                                                "s": "FOREXCOM:DJI",
                                                                                                                                "d": "Dow 30"
                                                                                                                            },
                                                                                                                            {
                                                                                                                                "s": "INDEX:NKY",
                                                                                                                                "d": "Nikkei 225"
                                                                                                                            },
                                                                                                                            {
                                                                                                                                "s": "INDEX:DEU40",
                                                                                                                                "d": "DAX Index"
                                                                                                                            },
                                                                                                                            {
                                                                                                                                "s": "FOREXCOM:UKXGBP",
                                                                                                                                "d": "FTSE 100"
                                                                                                                            }
                                                                                                                        ],
                                                                                                                        "originalTitle": "Indices"
                                                                                                                    }
                                                                                                                ]
                                }
                            </script>
                    </div>
                </div>
            </div>

            <!-- 5. Financial Headlines -->
            <div class="card col-span-2" id="widget-news">
                <div class="card-header">
                    <span class="card-title">Market Signals</span>
                </div>
                <div class="card-content" style="padding:0; overflow:hidden; position:relative;">
                    <!-- TradingView Widget BEGIN -->
                    <div class="tradingview-widget-container" style="height:100%; width:100%">
                        <div class="tradingview-widget-container__widget" style="height:calc(100% - 32px); width:100%">
                        </div>
                        <script type="text/javascript"
                            src="https://s3.tradingview.com/external-embedding/embed-widget-timeline.js" async>
                                {
                                    "feedMode": "all_symbols",
                                        "colorTheme": "dark",
                                            "isTransparent": true,
                                                "displayMode": "regular",
                                                    "width": "100%",
                                                        "height": "100%",
                                                            "locale": "en"
                                }
                            </script>
                    </div>
                </div>
            </div>

            <!-- 6. LLM Chatbot -->
            <div class="card" id="widget-chat" style="display: flex; flex-direction: column;">
                <div class="card-header">
                    <span class="card-title">Neural Uplink</span>
                    <button id="chat-settings-btn" onclick="toggleChatSettings()"
                        style="background:none; border:none; color:#666; cursor:pointer;">⚙️</button>
                </div>
                <div class="card-content" style="display: flex; flex-direction: column; overflow: hidden; padding: 0;">

                    <!-- View: Setup -->
                    <div id="chat-setup"
                        style="padding: 20px; display: flex; flex-direction: column; gap: 15px; height: 100%; justify-content: center;">
                        <p style="font-size: 0.8rem; color: #888; text-align: center;">Enter OpenAI API Key for live
                            intelligence.</p>

                        <input type="password" id="api-key-input" placeholder="sk-..."
                            style="background: #222; border: 1px solid #333; color: white; padding: 10px; border-radius: 4px; outline: none;">

                        <div style="display:flex; gap:10px;">
                            <select id="model-select"
                                style="flex-grow:1; background: #222; border: 1px solid #333; color: white; padding: 10px; border-radius: 4px; outline: none;">
                                <option value="gpt-4o">GPT-4o</option>
                                <option value="gpt-4-turbo">GPT-4 Turbo</option>
                                <option value="gpt-3.5-turbo" selected>GPT-3.5 Turbo</option>
                            </select>
                            <button onclick="fetchModels()" title="Refresh Models"
                                style="background: #222; border: 1px solid #333; color: var(--accent); padding: 0 15px; border-radius: 4px; cursor: pointer;">↻</button>
                        </div>

                        <div style="display: flex; gap: 10px;">
                            <button onclick="saveChatSettings()"
                                style="flex-grow: 1; background: var(--accent); color: black; border: none; padding: 10px; border-radius: 4px; font-weight: bold; cursor: pointer;">CONNECT</button>
                            <button onclick="clearChatSettings()" id="disconnect-btn"
                                style="display:none; background: #331111; color: #ff4444; border: 1px solid #552222; padding: 10px; border-radius: 4px; font-weight: bold; cursor: pointer;">X</button>
                        </div>

                        <div id="model-msg"
                            style="font-size: 0.7rem; color: #666; text-align: center; min-height: 1em;"></div>
                    </div>

                    <!-- View: Chat Interface -->
                    <div id="chat-interface" style="display: none; flex-direction: column; height: 100%;">
                        <div id="chat-messages"
                            style="flex-grow: 1; overflow-y: auto; padding: 10px; display: flex; flex-direction: column; gap: 10px;">
                            <div class="msg system"
                                style="align-self: flex-start; background: #222; padding: 8px 12px; border-radius: 8px; font-size: 0.85rem; color: #ccc;">
                                System online. Awaiting input.
                            </div>
                        </div>
                        <div style="padding: 10px; border-top: 1px solid #222; display: flex; gap: 10px;">
                            <input type="text" id="chat-input" placeholder="Broadcast message..."
                                onkeypress="if(event.key==='Enter') sendChatMessage()"
                                style="flex-grow: 1; background: transparent; border: none; color: white; outline: none; font-family: inherit;">
                            <button onclick="sendChatMessage()"
                                style="background: none; border: none; color: var(--accent); cursor: pointer;">→</button>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>

    <script>
        // Placeholder for widget scripts
        // --- Clocks Widget ---
        function updateClocks() {
            const now = new Date();
            const formatTime = (tz) => {
                try {
                    return now.toLocaleTimeString('en-US', {
                        timeZone: tz,
                        hour12: false,
                        hour: '2-digit',
                        minute: '2-digit',
                        second: '2-digit'
                    });
                } catch (e) {
                    return "--:--:--";
                }
            };

            document.getElementById('time1').innerText = formatTime(document.getElementById('tz1').value);
            document.getElementById('time2').innerText = formatTime(document.getElementById('tz2').value);
            document.getElementById('time3').innerText = formatTime(document.getElementById('tz3').value);
        }
        setInterval(updateClocks, 1000);
        updateClocks(); // Initial call

        // --- Weather Widget ---
        // --- Weather Widget ---
        function analyzeWeather(temp, wc) {
            let condition = "Unknown";
            let advice = "";

            // 1. Decode Condition
            if (wc === 0) condition = "Clear Sky";
            else if (wc >= 1 && wc <= 3) condition = "Partly Cloudy";
            else if (wc >= 45 && wc <= 48) condition = "Foggy";
            else if (wc >= 51 && wc <= 55) condition = "Drizzle";
            else if (wc >= 61 && wc <= 65) condition = "Rain";
            else if (wc >= 71 && wc <= 77) condition = "Snow";
            else if (wc >= 80 && wc <= 82) condition = "Showers";
            else if (wc >= 95) condition = "Thunderstorm";

            // 2. Generate Smart Advice
            // Extreme Cold
            if (temp <= -10) advice = "Hazardous cold. Thermal insulation mandatory.";
            // Freezing
            else if (temp <= 0) {
                if (wc >= 71) advice = "Icy conditions. Tread carefully.";
                else advice = "Freezing point. Layer up.";
            }
            // Cold (0-10)
            else if (temp <= 10) {
                if (wc >= 61) advice = "Cold & wet. Waterproof insulation required.";
                else advice = "Chilly atmosphere. Jacket recommended.";
            }
            // Moderate (10-20)
            else if (temp <= 20) {
                if (wc === 0) advice = "Optimal operating conditions.";
                else if (wc >= 51) advice = "Mild but damp. Light protection advised.";
                else advice = "Standard conditions.";
            }
            // Warm (20-30)
            else if (temp <= 30) {
                if (wc === 0) advice = "Warm & clear. Ideal.";
                else advice = "Warm & humid. Monitor comfort.";
            }
            // Hot (30+)
            else advice = "High heat. Maintain hydration protocols.";

            // Critical Overrides
            if (wc >= 95) advice = "Electrical storm. Seek shelter immediately.";
            if (wc === 45 || wc === 48) advice += " (Low visibility)";

            return { condition, advice };
        }

        async function initWeather() {
            try {
                let lat, lon, city, country;

                // 1. Get Location (Try ipapi.co first, then ipwho.is)
                try {
                    const locRes = await fetch('https://ipapi.co/json/');
                    if (locRes.ok) {
                        const locData = await locRes.json();
                        if (!locData.error) {
                            lat = locData.latitude;
                            lon = locData.longitude;
                            city = locData.city;
                            country = locData.country_code;
                        } else {
                            throw new Error(locData.reason || "ipapi error");
                        }
                    } else {
                        throw new Error("ipapi non-200");
                    }
                } catch (err) {
                    console.warn("ipapi failed, trying ipwho.is...", err);
                    // Fallback: ipwho.is
                    const backupRes = await fetch('https://ipwho.is/');
                    if (!backupRes.ok) throw new Error("Backup IP service failed");
                    const backupData = await backupRes.json();
                    if (!backupData.success) throw new Error(backupData.message);

                    lat = backupData.latitude;
                    lon = backupData.longitude;
                    city = backupData.city;
                    country = backupData.country_code;
                }

                if (city) {
                    document.getElementById('weather-location').innerText = `${city}, ${country}`;
                }

                // 2. Get Weather
                if (!lat || !lon) throw new Error("Coordinates not found");

                // Using Open-Meteo API
                const weatherRes = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true`);
                if (!weatherRes.ok) throw new Error("Weather API failed");

                const weatherData = await weatherRes.json();
                const current = weatherData.current_weather;

                document.getElementById('weather-temp').innerText = `${Math.round(current.temperature)}°C`;

                // Interpret wmo code
                const wmo = current.weathercode;
                const temp = Math.round(current.temperature);

                // Smart Analysis
                const analysis = analyzeWeather(temp, wmo);

                document.getElementById('weather-condition').innerText = analysis.condition;
                document.getElementById('weather-advice').innerText = analysis.advice;

            } catch (error) {
                console.error("Weather Error:", error);
                document.getElementById('weather-location').innerText = "Signal Lost";
                document.getElementById('weather-advice').innerText = "Error: " + error.message;
            }
        }
        initWeather();

        // --- Chatbot Widget ---
        let chatApiKey = localStorage.getItem('chat_api_key') || '';
        let chatModel = localStorage.getItem('chat_model') || 'gpt-3.5-turbo';

        const chatSetup = document.getElementById('chat-setup');
        const chatInterface = document.getElementById('chat-interface');
        const chatInput = document.getElementById('chat-input');
        const chatMessages = document.getElementById('chat-messages');
        const disconnectBtn = document.getElementById('disconnect-btn');
        const modelSelect = document.getElementById('model-select');
        const modelMsg = document.getElementById('model-msg');

        // Restore selected model if exists
        if (chatModel) {
            // If the saved model isn't in the default list, add it
            if (![...modelSelect.options].some(o => o.value === chatModel)) {
                const opt = document.createElement('option');
                opt.value = chatModel;
                opt.text = chatModel;
                modelSelect.add(opt);
            }
            modelSelect.value = chatModel;
        }

        function toggleChatSettings() {
            if (chatSetup.style.display === 'flex') {
                // If we are in setup, only allow closing if we have a key (or if we want to cancel setup)
                // But simplified: just toggle views
                chatSetup.style.display = 'none';
                chatInterface.style.display = 'flex';
            } else {
                chatSetup.style.display = 'flex';
                chatInterface.style.display = 'none';

                // Show disconnect button if logged in
                disconnectBtn.style.display = chatApiKey ? 'block' : 'none';
                document.getElementById('api-key-input').value = chatApiKey;
            }
        }

        async function fetchModels() {
            const key = document.getElementById('api-key-input').value.trim() || chatApiKey;
            if (!key) {
                modelMsg.innerText = "API Key required to fetch models.";
                return;
            }

            modelMsg.innerText = "Fetching models...";
            try {
                const res = await fetch('https://api.openai.com/v1/models', {
                    headers: { 'Authorization': `Bearer ${key}` }
                });

                if (!res.ok) throw new Error("Failed to fetch");

                const data = await res.json();
                const models = data.data.filter(m => m.id.includes('gpt')).sort((a, b) => b.created - a.created);

                // Clear and repopulate
                modelSelect.innerHTML = '';
                models.forEach(m => {
                    const opt = document.createElement('option');
                    opt.value = m.id;
                    opt.innerText = m.id;
                    modelSelect.appendChild(opt);
                });

                modelMsg.innerText = `${models.length} models found.`;
                modelMsg.style.color = "#00ff88";

            } catch (e) {
                modelMsg.innerText = "Error fetching models. Using defaults.";
                modelMsg.style.color = "#ff4444";
            }
        }

        function saveChatSettings() {
            const key = document.getElementById('api-key-input').value.trim();
            const model = modelSelect.value;

            if (key) {
                chatApiKey = key;
                chatModel = model;
                localStorage.setItem('chat_api_key', key);
                localStorage.setItem('chat_model', model);
                disconnectBtn.style.display = 'block';
                appendMessage('system', `Linked to ${model}.`);
            } else {
                // Mock mode logic if needed, or just warn
                if (!chatApiKey) appendMessage('system', "Simulation mode active (No Key).");
            }

            chatSetup.style.display = 'none';
            chatInterface.style.display = 'flex';
        }

        function clearChatSettings() {
            chatApiKey = '';
            localStorage.removeItem('chat_api_key');
            document.getElementById('api-key-input').value = '';
            disconnectBtn.style.display = 'none';
            appendMessage('system', "Link severed. Data cleared.");
        }

        // Auto-load if key exists
        if (chatApiKey) {
            document.getElementById('api-key-input').value = chatApiKey;
            disconnectBtn.style.display = 'block';
            chatSetup.style.display = 'none';
            chatInterface.style.display = 'flex';
        } else {
            // Show setup by default if no key? No, show empty chat or setup? 
            // Let's show setup if no key is present initially
            chatSetup.style.display = 'flex';
            chatInterface.style.display = 'none';
        }

        // Auto-load if key exists
        if (chatApiKey) {
            document.getElementById('api-key-input').value = chatApiKey;
            chatSetup.style.display = 'none';
            chatInterface.style.display = 'flex';
        }

        function appendMessage(role, text) {
            const div = document.createElement('div');
            div.className = `msg ${role}`;
            div.style.maxWidth = '85%';
            div.style.padding = '8px 12px';
            div.style.borderRadius = '8px';
            div.style.fontSize = '0.85rem';
            div.style.lineHeight = '1.4';
            div.style.marginBottom = '10px';

            if (role === 'user') {
                div.style.alignSelf = 'flex-end';
                div.style.background = 'rgba(0, 255, 136, 0.1)';
                div.style.color = '#fff';
                div.style.border = '1px solid rgba(0, 255, 136, 0.2)';
            } else {
                div.style.alignSelf = 'flex-start';
                div.style.background = '#222';
                div.style.color = '#ccc';
            }

            div.innerText = text;
            chatMessages.appendChild(div);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        async function sendChatMessage() {
            const text = chatInput.value.trim();
            if (!text) return;

            appendMessage('user', text);
            chatInput.value = '';

            // Simulate 'typing'
            const ellipsis = document.createElement('div');
            ellipsis.id = 'typing-indicator';
            ellipsis.className = 'msg system';
            ellipsis.innerText = 'Processing...';
            ellipsis.style.alignSelf = 'flex-start';
            ellipsis.style.color = '#666';
            ellipsis.style.fontSize = '0.7rem';
            chatMessages.appendChild(ellipsis);

            try {
                let responseText = "";

                if (chatApiKey) {
                    // REAL CALL (OpenAI)
                    const payload = {
                        model: chatModel,
                        messages: [{ role: "user", content: text }]
                    };

                    // New o1 models and some future models use 'max_completion_tokens'
                    // Older models use 'max_tokens'
                    if (chatModel.startsWith('o1')) {
                        payload.max_completion_tokens = 1500; // o1 usually needs more room for reasoning
                    } else {
                        payload.max_tokens = 150;
                    }

                    const res = await fetch('https://api.openai.com/v1/chat/completions', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${chatApiKey}`
                        },
                        body: JSON.stringify(payload)
                    });
                    const data = await res.json();
                    if (data.error) throw new Error(data.error.message);
                    responseText = data.choices[0].message.content;
                } else {
                    // MOCK CALL
                    await new Promise(r => setTimeout(r, 1000));
                    const mocks = [
                        "I am calculating the optimal trajectory for these market conditions.",
                        "Analysis complete. The heuristic index suggests a hold pattern.",
                        "Please define your request with more precision.",
                        "My neural pathways are focused on the S&P 500 variance.",
                        "Observation: The user is seeking validation.",
                        "Accessing global knowledge base... [ACCESS DENIED]... Using backup logic.",
                        "That is an interesting variable. Let me add it to the simulation."
                    ];
                    responseText = mocks[Math.floor(Math.random() * mocks.length)];
                }

                if (document.body.contains(ellipsis)) {
                    chatMessages.removeChild(ellipsis);
                }
                appendMessage('system', responseText);

            } catch (err) {
                if (document.body.contains(ellipsis)) {
                    chatMessages.removeChild(ellipsis);
                }
                appendMessage('system', `Error: ${err.message}`);
            }
        }
    </script>
</body>

</html>