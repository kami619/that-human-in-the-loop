<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Heuristics | In the Loop</title>
    <link rel="stylesheet" href="theme.css">
    <style>
        :root {
            --card-bg: #111;
            --text-dim: #888;
            --border: #333;
            --card-radius: 12px;
        }

        body,
        html {
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 0 40px;
            border-bottom: 1px solid var(--border);
            margin-bottom: 20px;
        }

        h1 {
            font-size: 1.5rem;
            letter-spacing: 2px;
            text-transform: uppercase;
            margin: 0;
        }

        h1 span {
            color: var(--accent);
        }

        .back-link {
            text-decoration: none;
            color: var(--text-dim);
            font-size: 0.9rem;
            transition: color 0.3s;
        }

        .back-link:hover {
            color: var(--accent);
        }

        /* Grid Layout */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            grid-auto-rows: minmax(300px, auto);
        }

        /* Responsive adjustments */
        @media (max-width: 1024px) {
            .dashboard-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 768px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Card Styles */
        .card {
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: var(--card-radius);
            padding: 20px;
            display: flex;
            flex-direction: column;
            position: relative;
            overflow: hidden;
            transition: transform 0.3s, border-color 0.3s;
        }

        .card:hover {
            border-color: var(--accent);
            transform: translateY(-2px);
        }

        .card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .card-title {
            font-size: 1rem;
            font-weight: bold;
            color: var(--accent);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .card-content {
            flex-grow: 1;
            overflow: auto;
        }

        /* Specific Spans */
        .col-span-2 {
            grid-column: span 2;
        }

        .row-span-2 {
            grid-row: span 2;
        }

        @media (max-width: 1024px) {
            .col-span-2 {
                grid-column: span 1;
            }
        }

        /* Timezone select */
        .timezone-select {
            background: transparent;
            color: #888;
            border: none;
            outline: none;
            font-family: inherit;
            font-size: 0.8rem;
            cursor: pointer;
        }

        .timezone-select:hover {
            color: #fff;
        }

        /* TradingView containers */
        .tradingview-widget-container {
            height: 100%;
            width: 100%;
        }

        .tradingview-widget-container__widget {
            height: calc(100% - 32px);
            width: 100%;
        }

        /* Stellar Explorer CTA */
        .cta-link {
            margin-top: auto;
            margin-bottom: 5px;
            display: inline-block;
            padding: 10px 20px;
            background: rgba(0, 255, 136, 0.05);
            border: 1px solid var(--accent);
            color: var(--accent);
            text-decoration: none;
            border-radius: 6px;
            font-size: 0.8rem;
            letter-spacing: 1px;
            font-weight: bold;
            transition: all 0.3s;
            z-index: 1;
            box-shadow: 0 0 10px rgba(0, 255, 136, 0.1);
        }

        .cta-link:hover {
            background: var(--accent);
            color: #000;
            box-shadow: 0 0 20px rgba(0, 255, 136, 0.4);
            transform: translateY(-2px);
        }

        /* BFCL leaderboard rows */
        .bfcl-row {
            border-bottom: 1px solid #222;
        }

        .bfcl-row td {
            padding: 10px 4px;
        }

        .bfcl-top3 {
            color: var(--accent);
        }

        .bfcl-provider {
            color: #999;
            font-size: 0.7rem;
        }

        .bfcl-acc {
            text-align: right;
        }

        /* Clock rows */
        .clocks-content {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .clock-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 8px;
        }

        .clock-row:not(:last-child) {
            border-bottom: 1px solid #222;
        }

        .time-display {
            font-family: monospace;
            font-size: 1.1rem;
            color: var(--accent);
        }
    </style>
</head>

<body>

    <div class="container">
        <header>
            <h1>Heuristics <span>Dashboard</span></h1>
            <a href="index.html" class="back-link">&larr; Back to The Loop</a>
        </header>

        <div class="dashboard-grid">
            <!-- 1. Weather Widget -->
            <div class="card" id="widget-weather">
                <div class="card-header">
                    <span class="card-title">Local Atmosphere</span>
                    <span id="weather-location" style="font-size: 0.8rem; color: #666;">Locating...</span>
                </div>
                <div class="card-content"
                    style="display: flex; flex-direction: column; justify-content: space-between;">
                    <div style="display: flex; align-items: center; gap: 15px;">
                        <div id="weather-temp" style="font-size: 2.5rem; font-weight: bold; color: var(--text);">--¬∞C
                        </div>
                        <div id="weather-condition" style="color: var(--accent); text-transform: uppercase;">Scanning...
                        </div>
                    </div>
                    <div class="recommendation"
                        style="margin-top: 15px; padding: 10px; background: rgba(255,255,255,0.05); border-radius: 8px; font-size: 0.9rem;">
                        <span style="color: #888;">ADVISORY:</span> <span id="weather-advice">Awaiting data...</span>
                    </div>
                </div>
            </div>

            <!-- 2. Clocks Widget -->
            <div class="card" id="widget-clocks">
                <div class="card-header">
                    <span class="card-title">Chronometers</span>
                </div>
                <div class="card-content clocks-content" id="clocks-content"></div>
            </div>

            <!-- 3. BFCL Tool Calling Leaderboard Widget -->
            <div class="card row-span-2" id="widget-arena">
                <div class="card-header">
                    <span class="card-title">üîß Tool Calling Arena</span>
                    <span style="font-size: 0.7rem; color: #666;">BFCL V4</span>
                </div>
                <div class="card-content">
                    <table style="width: 100%; border-collapse: collapse; font-size: 0.8rem;">
                        <thead>
                            <tr style="border-bottom: 1px solid #333; text-align: left;">
                                <th style="padding: 8px 4px; color: #888;">#</th>
                                <th style="padding: 8px 4px; color: #888;">MODEL</th>
                                <th style="padding: 8px 4px; text-align: right; color: #888;">ACC %</th>
                            </tr>
                        </thead>
                        <tbody id="bfcl-tbody">
                            <tr>
                                <td colspan="3" style="padding: 20px; text-align: center; color: #555;">Loading...</td>
                            </tr>
                        </tbody>
                    </table>
                    <div style="margin-top: 15px; text-align: center;">
                        <a href="https://gorilla.cs.berkeley.edu/leaderboard.html" target="_blank"
                            style="font-size: 0.75rem; color: var(--accent); text-decoration: none;">
                            View Full BFCL Leaderboard ‚Üí
                        </a>
                    </div>
                    <div style="margin-top: 8px; font-size: 0.65rem; color: #444; text-align: center;">
                        Berkeley Function-Calling Leaderboard
                    </div>
                </div>
            </div>


            <!-- 4. Major Indices Widget (Wide) -->
            <div class="card col-span-2" id="widget-indices">
                <div class="card-header">
                    <span class="card-title">Global Markets</span>
                </div>
                <div class="card-content" style="padding:0; overflow:hidden; position:relative;">
                    <!-- TradingView Widget BEGIN -->
                    <div class="tradingview-widget-container">
                        <div class="tradingview-widget-container__widget">
                        </div>
                        <script type="text/javascript"
                            src="https://s3.tradingview.com/external-embedding/embed-widget-market-overview.js" async>
                                {
                                    "colorTheme": "dark",
                                        "dateRange": "12M",
                                            "showChart": true,
                                                "locale": "en",
                                                    "largeChartUrl": "",
                                                        "isTransparent": true,
                                                            "showSymbolLogo": true,
                                                                "showFloatingTooltip": false,
                                                                    "width": "100%",
                                                                        "height": "100%",
                                                                            "plotLineColorGrowing": "rgba(0, 255, 136, 1)",
                                                                                "plotLineColorFalling": "rgba(255, 0, 0, 1)",
                                                                                    "gridLineColor": "rgba(240, 243, 250, 0)",
                                                                                        "scaleFontColor": "rgba(106, 109, 120, 1)",
                                                                                            "belowLineFillColorGrowing": "rgba(0, 255, 136, 0.12)",
                                                                                                "belowLineFillColorFalling": "rgba(255, 0, 0, 0.12)",
                                                                                                    "belowLineFillColorGrowingBottom": "rgba(0, 255, 136, 0)",
                                                                                                        "belowLineFillColorFallingBottom": "rgba(255, 0, 0, 0)",
                                                                                                            "symbolActiveColor": "rgba(0, 255, 136, 0.12)",
                                                                                                                "tabs": [
                                                                                                                    {
                                                                                                                        "title": "Indices",
                                                                                                                        "symbols": [
                                                                                                                            {
                                                                                                                                "s": "FOREXCOM:SPXUSD",
                                                                                                                                "d": "S&P 500"
                                                                                                                            },
                                                                                                                            {
                                                                                                                                "s": "FOREXCOM:NSXUSD",
                                                                                                                                "d": "Nasdaq 100"
                                                                                                                            },
                                                                                                                            {
                                                                                                                                "s": "FOREXCOM:DJI",
                                                                                                                                "d": "Dow 30"
                                                                                                                            },
                                                                                                                            {
                                                                                                                                "s": "INDEX:NKY",
                                                                                                                                "d": "Nikkei 225"
                                                                                                                            },
                                                                                                                            {
                                                                                                                                "s": "INDEX:DEU40",
                                                                                                                                "d": "DAX Index"
                                                                                                                            },
                                                                                                                            {
                                                                                                                                "s": "FOREXCOM:UKXGBP",
                                                                                                                                "d": "FTSE 100"
                                                                                                                            }
                                                                                                                        ],
                                                                                                                        "originalTitle": "Indices"
                                                                                                                    }
                                                                                                                ]
                                }
                            </script>
                    </div>
                </div>
            </div>

            <!-- 5. Financial Headlines -->
            <div class="card col-span-2" id="widget-news">
                <div class="card-header">
                    <span class="card-title">Market Signals</span>
                </div>
                <div class="card-content" style="padding:0; overflow:hidden; position:relative;">
                    <!-- TradingView Widget BEGIN -->
                    <div class="tradingview-widget-container">
                        <div class="tradingview-widget-container__widget">
                        </div>
                        <script type="text/javascript"
                            src="https://s3.tradingview.com/external-embedding/embed-widget-timeline.js" async>
                                {
                                    "feedMode": "all_symbols",
                                        "colorTheme": "dark",
                                            "isTransparent": true,
                                                "displayMode": "regular",
                                                    "width": "100%",
                                                        "height": "100%",
                                                            "locale": "en"
                                }
                            </script>
                    </div>
                </div>
            </div>


            <!-- 6. Stellar Explorer -->
            <div class="card" id="widget-solar-system">
                <div class="card-header">
                    <span class="card-title">Stellar Explorer</span>
                </div>
                <div class="card-content"
                    style="display: flex; flex-direction: column; justify-content: space-between; align-items: center; text-align: center; overflow: hidden; position: relative;">
                    <!-- Ambient background glow behind planet -->
                    <div
                        style="position: absolute; width: 150px; height: 150px; background: radial-gradient(circle, rgba(96,165,250,0.15) 0%, rgba(0,0,0,0) 70%); top: 50%; left: 50%; transform: translate(-50%, -60%); z-index: 0; pointer-events: none;">
                    </div>

                    <div
                        style="font-size: 3.5rem; margin-top: 15px; filter: drop-shadow(0 0 10px rgba(96,165,250,0.4)); z-index: 1;">
                        ü™ê</div>

                    <div
                        style="margin-top: 15px; color: var(--text-dim); font-size: 0.85rem; z-index: 1; padding: 0 10px;">
                        Interactive procedural 3D Solar System & Kuiper Belt simulation.
                    </div>

                    <a href="solar-system.html" class="cta-link">ENTER SIMULATION</a>
                </div>
            </div>

        </div>
    </div>

    <script>
        // --- Clocks Widget ---
        const CLOCKS = [
            { id: 'tz1', tz: 'America/New_York' },
            { id: 'tz2', tz: 'Europe/London'    },
            { id: 'tz3', tz: 'Asia/Tokyo'       },
        ];

        const TZ_OPTIONS = [
            { value: 'America/New_York', label: 'New York' },
            { value: 'Europe/London',    label: 'London'   },
            { value: 'Asia/Tokyo',       label: 'Tokyo'    },
            { value: 'UTC',              label: 'UTC'      },
        ];

        // Render clock rows from config
        document.getElementById('clocks-content').innerHTML = CLOCKS.map((clock, i) => `
            <div class="clock-row">
                <select class="timezone-select" id="${clock.id}">
                    ${TZ_OPTIONS.map(opt =>
                        `<option value="${opt.value}"${opt.value === clock.tz ? ' selected' : ''}>${opt.label}</option>`
                    ).join('')}
                </select>
                <div class="time-display" id="time${i + 1}">--:--:--</div>
            </div>
        `).join('');

        // Cache element refs
        const clockEls = CLOCKS.map((clock, i) => ({
            select: document.getElementById(clock.id),
            display: document.getElementById('time' + (i + 1)),
        }));

        function formatTime(tz) {
            try {
                return new Date().toLocaleTimeString('en-US', {
                    timeZone: tz,
                    hour12: false,
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                });
            } catch (e) {
                return '--:--:--';
            }
        }

        function updateClocks() {
            clockEls.forEach(({ select, display }) => {
                display.innerText = formatTime(select.value);
            });
        }

        clockEls.forEach(({ select }) => select.addEventListener('change', updateClocks));
        setInterval(updateClocks, 1000);
        updateClocks();

        // --- Weather Widget ---
        function analyzeWeather(temp, wc) {
            let condition = "Unknown";
            let advice = "";

            // 1. Decode Condition
            if (wc === 0) condition = "Clear Sky";
            else if (wc >= 1 && wc <= 3) condition = "Partly Cloudy";
            else if (wc >= 45 && wc <= 48) condition = "Foggy";
            else if (wc >= 51 && wc <= 55) condition = "Drizzle";
            else if (wc >= 61 && wc <= 65) condition = "Rain";
            else if (wc >= 71 && wc <= 77) condition = "Snow";
            else if (wc >= 80 && wc <= 82) condition = "Showers";
            else if (wc >= 95) condition = "Thunderstorm";

            // 2. Generate Advice ‚Äî thunderstorm is highest priority, checked first
            if (wc >= 95) {
                advice = "Electrical storm. Seek shelter immediately.";
            } else if (temp <= -10) {
                advice = "Hazardous cold. Thermal insulation mandatory.";
            } else if (temp <= 0) {
                advice = wc >= 71 ? "Icy conditions. Tread carefully." : "Freezing point. Layer up.";
            } else if (temp <= 10) {
                advice = wc >= 61 ? "Cold & wet. Waterproof insulation required." : "Chilly atmosphere. Jacket recommended.";
            } else if (temp <= 20) {
                if (wc === 0) advice = "Optimal operating conditions.";
                else if (wc >= 51) advice = "Mild but damp. Light protection advised.";
                else advice = "Standard conditions.";
            } else if (temp <= 30) {
                advice = wc === 0 ? "Warm & clear. Ideal." : "Warm & humid. Monitor comfort.";
            } else {
                advice = "High heat. Maintain hydration protocols.";
            }

            // Fog append (mutually exclusive with thunderstorm codes)
            if (wc === 45 || wc === 48) advice += " (Low visibility)";

            return { condition, advice };
        }

        async function initWeather() {
            try {
                let lat, lon, city, country;

                // 1. Get Location (Try ipapi.co first, then ipwho.is)
                try {
                    const locRes = await fetch('https://ipapi.co/json/');
                    if (locRes.ok) {
                        const locData = await locRes.json();
                        if (!locData.error) {
                            lat = locData.latitude;
                            lon = locData.longitude;
                            city = locData.city;
                            country = locData.country_code;
                        } else {
                            throw new Error(locData.reason || "ipapi error");
                        }
                    } else {
                        throw new Error("ipapi non-200");
                    }
                } catch (err) {
                    console.warn("ipapi failed, trying ipwho.is...", err);
                    // Fallback: ipwho.is
                    const backupRes = await fetch('https://ipwho.is/');
                    if (!backupRes.ok) throw new Error("Backup IP service failed");
                    const backupData = await backupRes.json();
                    if (!backupData.success) throw new Error(backupData.message);

                    lat = backupData.latitude;
                    lon = backupData.longitude;
                    city = backupData.city;
                    country = backupData.country_code;
                }

                if (city) {
                    document.getElementById('weather-location').innerText = `${city}, ${country}`;
                }

                // 2. Get Weather
                if (!lat || !lon) throw new Error("Coordinates not found");

                // Using Open-Meteo API
                const weatherRes = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true`);
                if (!weatherRes.ok) throw new Error("Weather API failed");

                const weatherData = await weatherRes.json();
                const current = weatherData.current_weather;

                document.getElementById('weather-temp').innerText = `${Math.round(current.temperature)}¬∞C`;

                // Interpret wmo code
                const wmo = current.weathercode;
                const temp = Math.round(current.temperature);

                // Smart Analysis
                const analysis = analyzeWeather(temp, wmo);

                document.getElementById('weather-condition').innerText = analysis.condition;
                document.getElementById('weather-advice').innerText = analysis.advice;

            } catch (error) {
                console.error("Weather Error:", error);
                document.getElementById('weather-location').innerText = "Signal Lost";
                document.getElementById('weather-advice').innerText = "Error: " + error.message;
            }
        }
        initWeather();

        // --- BFCL Leaderboard Widget ---
        async function initBFCL() {
            try {
                const response = await fetch('bfcl-leaderboard.json');
                if (!response.ok) throw new Error('Failed to load leaderboard data');

                const data = await response.json();
                const tbody = document.getElementById('bfcl-tbody');

                // Render top 6 models
                const models = data.leaderboard.slice(0, 6);
                tbody.innerHTML = models.map((m, i) => `
                    <tr class="bfcl-row">
                        <td class="${i < 3 ? 'bfcl-top3' : ''}">${m.rank}</td>
                        <td>
                            <span class="bfcl-provider">${m.provider}</span><br>
                            ${m.model}
                        </td>
                        <td class="bfcl-acc ${i < 3 ? 'bfcl-top3' : ''}">${m.accuracy.toFixed(1)}</td>
                    </tr>
                `).join('');

            } catch (error) {
                console.error('BFCL Error:', error);
                document.getElementById('bfcl-tbody').innerHTML =
                    '<tr><td colspan="3" style="padding: 20px; text-align: center; color: #f66;">Failed to load</td></tr>';
            }
        }
        initBFCL();


    </script>
</body>

</html>